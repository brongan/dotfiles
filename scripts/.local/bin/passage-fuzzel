#! /usr/bin/env bash
set -eou pipefail

PREFIX="${PASSAGE_DIR:-${XDG_CONFIG_HOME:-$HOME/.config}/passage/store}"

selection=$(find "$PREFIX" -type f -name '*.age' |
    sed -e "s|^$PREFIX/||" -e 's|\.age$||' |
    sort |
    fuzzel -d -p "üîê Pass: " -l 15 --width 60)

[ -z "$selection" ] && exit 0

if kitty --class "passage-pin" --title "Passage PIN" sh -c "passage -c '$selection'; exit"; then
    notify-send "Passage" "Copied $selection"
else
    notify-send -u critical "Passage" "Failed to decrypt $selection"
fi
